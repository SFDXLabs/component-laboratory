/**
 * @description Test class for CustomListViewController
 * @author Generated by Claude
 */
@isTest
private class CustomListViewControllerTest {
    
    @TestSetup
    static void setupTestData() {
        // Create test accounts
        List<Account> accounts = new List<Account>();
        for (Integer i = 0; i < 25; i++) {
            accounts.add(new Account(
                Name = 'Test Account ' + String.valueOf(i).leftPad(2, '0'),
                Industry = 'Technology',
                Website = 'https://test' + i + '.com',
                Phone = '555-000-' + String.valueOf(i).leftPad(4, '0')
            ));
        }
        insert accounts;
        
        // Create test contacts
        List<Contact> contacts = new List<Contact>();
        for (Account acc : accounts) {
            contacts.add(new Contact(
                FirstName = 'Test',
                LastName = 'Contact ' + acc.Name,
                AccountId = acc.Id,
                Email = 'test@' + acc.Name.replace(' ', '') + '.com'
            ));
        }
        insert contacts;
    }
    
    @isTest
    static void testExecuteQuery_BasicQuery() {
        // Test basic query execution
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name, Industry FROM Account',
            null,
            '',
            'Name',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query should succeed');
        System.assertEquals(25, result.totalCount, 'Should return total count of 25');
        System.assertEquals(10, result.records.size(), 'Should return 10 records for first page');
        System.assertNotEquals(null, result.fieldMetadata, 'Should return field metadata');
    }
    
    @isTest
    static void testExecuteQuery_WithRecordId() {
        // Get an account to use as context
        Account testAccount = [SELECT Id FROM Account LIMIT 1];
        
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, FirstName, LastName, Email FROM Contact WHERE AccountId = {recordId}',
            testAccount.Id,
            '',
            'LastName',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query should succeed');
        System.assertEquals(1, result.totalCount, 'Should find 1 contact for the account');
    }
    
    @isTest
    static void testExecuteQuery_WithCurrentUserId() {
        // Test that {currentUserId} placeholder is correctly replaced
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name FROM Account WHERE OwnerId = {currentUserId}',
            null,
            '',
            'Name',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query with currentUserId should succeed');
        // All test accounts are owned by the current user, so should return results
        System.assert(result.totalCount >= 0, 'Should return records owned by current user');
    }
    
    @isTest
    static void testExecuteQuery_WithBothPlaceholders() {
        // Test that both {recordId} and {currentUserId} work together
        Account testAccount = [SELECT Id FROM Account LIMIT 1];
        
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, FirstName, LastName FROM Contact WHERE AccountId = {recordId} AND OwnerId = {currentUserId}',
            testAccount.Id,
            '',
            'LastName',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query with both placeholders should succeed');
    }
    
    @isTest
    static void testExecuteQuery_WithSearch() {
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name, Industry FROM Account',
            null,
            'Account 01',
            'Name',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query should succeed');
        // Search should filter results
        System.assert(result.records.size() <= 25, 'Search should filter results');
    }
    
    @isTest
    static void testExecuteQuery_Pagination() {
        Test.startTest();
        
        // Get first page
        CustomListViewController.QueryResult page1 = CustomListViewController.executeQuery(
            'SELECT Id, Name FROM Account',
            null,
            '',
            'Name',
            'ASC',
            10,
            1,
            ''
        );
        
        // Get second page
        CustomListViewController.QueryResult page2 = CustomListViewController.executeQuery(
            'SELECT Id, Name FROM Account',
            null,
            '',
            'Name',
            'ASC',
            10,
            2,
            ''
        );
        
        Test.stopTest();
        
        System.assertEquals(10, page1.records.size(), 'Page 1 should have 10 records');
        System.assertEquals(10, page2.records.size(), 'Page 2 should have 10 records');
        
        // Verify different records
        Set<Id> page1Ids = new Set<Id>();
        for (SObject record : page1.records) {
            page1Ids.add(record.Id);
        }
        
        for (SObject record : page2.records) {
            System.assert(!page1Ids.contains(record.Id), 'Page 2 should have different records than Page 1');
        }
    }
    
    @isTest
    static void testExecuteQuery_SortingDesc() {
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name FROM Account',
            null,
            '',
            'Name',
            'DESC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query should succeed');
        
        // Verify descending order
        String previousName = '';
        for (SObject record : result.records) {
            String currentName = (String)record.get('Name');
            if (String.isNotBlank(previousName)) {
                System.assert(currentName.compareTo(previousName) <= 0, 
                    'Records should be in descending order: ' + previousName + ' should be >= ' + currentName);
            }
            previousName = currentName;
        }
    }
    
    @isTest
    static void testExecuteQuery_RelationshipFields() {
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, FirstName, LastName, Account.Name FROM Contact',
            null,
            '',
            'LastName',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query should succeed');
        System.assert(result.records.size() > 0, 'Should return contacts');
    }
    
    @isTest
    static void testExecuteQuery_EmptyQuery() {
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            '',
            null,
            '',
            '',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(false, result.success, 'Query should fail');
        System.assertNotEquals(null, result.errorMessage, 'Should have error message');
    }
    
    @isTest
    static void testExecuteQuery_InvalidQuery() {
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id FROM InvalidObject__c',
            null,
            '',
            '',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(false, result.success, 'Query should fail');
        System.assertNotEquals(null, result.errorMessage, 'Should have error message');
    }
    
    @isTest
    static void testExecuteQuery_WithWhereClause() {
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name FROM Account WHERE Industry = \'Technology\'',
            null,
            '',
            'Name',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query should succeed');
    }
    
    @isTest
    static void testGetRecordUrl() {
        Account testAccount = [SELECT Id FROM Account LIMIT 1];
        
        Test.startTest();
        String url = CustomListViewController.getRecordUrl(testAccount.Id);
        Test.stopTest();
        
        System.assertEquals('/' + testAccount.Id, url, 'URL should be correct');
    }
    
    @isTest
    static void testFieldMetadata() {
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name, Industry, CreatedDate, IsDeleted FROM Account',
            null,
            '',
            'Name',
            'ASC',
            10,
            1,
            ''
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query should succeed');
        System.assertNotEquals(null, result.fieldMetadata, 'Should have field metadata');
        System.assert(result.fieldMetadata.containsKey('Name'), 'Should have Name field metadata');
        System.assert(result.fieldMetadata.containsKey('Industry'), 'Should have Industry field metadata');
    }
    
    @isTest
    static void testExecuteQuery_WithQuickFilters() {
        // Test query with quick filters (single value in array)
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name, Industry FROM Account',
            null,
            '',
            'Name',
            'ASC',
            10,
            1,
            '{"Industry":["Technology"]}'
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query with filters should succeed');
        // All test accounts have Industry = Technology
        System.assertEquals(25, result.totalCount, 'Should return all accounts with Technology industry');
    }
    
    @isTest
    static void testExecuteQuery_WithMultiSelectFilters() {
        // Test query with multi-select filters (multiple values)
        // First, update some accounts with different industries
        List<Account> accounts = [SELECT Id, Industry FROM Account LIMIT 5];
        for (Integer i = 0; i < accounts.size(); i++) {
            if (i < 2) {
                accounts[i].Industry = 'Finance';
            } else if (i < 4) {
                accounts[i].Industry = 'Healthcare';
            }
        }
        update accounts;
        
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name, Industry FROM Account',
            null,
            '',
            'Name',
            'ASC',
            50,
            1,
            '{"Industry":["Finance","Healthcare"]}'
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query with multi-select filters should succeed');
        System.assertEquals(4, result.totalCount, 'Should return accounts with Finance OR Healthcare industry');
    }
    
    @isTest
    static void testExecuteQuery_WithMultipleFilters() {
        // Test query with multiple filters
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name, Industry FROM Account',
            null,
            '',
            'Name',
            'ASC',
            10,
            1,
            '{"Industry":["Technology"],"Name":["Test Account 01"]}'
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query with multiple filters should succeed');
        System.assertEquals(1, result.totalCount, 'Should return 1 account matching both filters');
    }
    
    @isTest
    static void testExecuteQuery_WithEmptyFiltersJson() {
        // Test query with empty filters JSON
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name FROM Account',
            null,
            '',
            'Name',
            'ASC',
            10,
            1,
            '{}'
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query with empty filters should succeed');
        System.assertEquals(25, result.totalCount, 'Should return all accounts');
    }
    
    @isTest
    static void testExecuteQuery_WithInvalidFiltersJson() {
        // Test query with invalid JSON - should gracefully handle
        Test.startTest();
        CustomListViewController.QueryResult result = CustomListViewController.executeQuery(
            'SELECT Id, Name FROM Account',
            null,
            '',
            'Name',
            'ASC',
            10,
            1,
            'invalid json'
        );
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Query should succeed even with invalid filter JSON');
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // Tests for searchUsers method
    // ═══════════════════════════════════════════════════════════════════
    
    @isTest
    static void testSearchUsers_ValidSearch() {
        // Get the current user's name to search for
        User currentUser = [SELECT Id, Name FROM User WHERE Id = :UserInfo.getUserId()];
        String searchTerm = currentUser.Name.substring(0, 3); // Use first 3 characters
        
        Test.startTest();
        List<User> results = CustomListViewController.searchUsers(searchTerm);
        Test.stopTest();
        
        System.assertNotEquals(null, results, 'Results should not be null');
        // At minimum, should find the current user
        System.assert(results.size() >= 0, 'Should return results or empty list');
    }
    
    @isTest
    static void testSearchUsers_EmptySearchTerm() {
        Test.startTest();
        List<User> results = CustomListViewController.searchUsers('');
        Test.stopTest();
        
        System.assertEquals(0, results.size(), 'Empty search term should return empty list');
    }
    
    @isTest
    static void testSearchUsers_ShortSearchTerm() {
        Test.startTest();
        List<User> results = CustomListViewController.searchUsers('a');
        Test.stopTest();
        
        System.assertEquals(0, results.size(), 'Single character search should return empty list');
    }
    
    @isTest
    static void testSearchUsers_NullSearchTerm() {
        Test.startTest();
        List<User> results = CustomListViewController.searchUsers(null);
        Test.stopTest();
        
        System.assertEquals(0, results.size(), 'Null search term should return empty list');
    }
    
    @isTest
    static void testSearchUsers_NoResults() {
        Test.startTest();
        List<User> results = CustomListViewController.searchUsers('ZZZZNONEXISTENT12345');
        Test.stopTest();
        
        System.assertEquals(0, results.size(), 'Non-matching search should return empty list');
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // Tests for changeRecordsOwner method
    // ═══════════════════════════════════════════════════════════════════
    
    @isTest
    static void testChangeRecordsOwner_Success() {
        // Get test accounts
        List<Account> accounts = [SELECT Id, OwnerId FROM Account LIMIT 3];
        List<String> accountIds = new List<String>();
        for (Account acc : accounts) {
            accountIds.add(acc.Id);
        }
        
        // Get current user as new owner
        String newOwnerId = UserInfo.getUserId();
        
        Test.startTest();
        CustomListViewController.OwnerChangeResult result = 
            CustomListViewController.changeRecordsOwner(accountIds, newOwnerId);
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Owner change should succeed');
        System.assertEquals(3, result.successCount, 'All 3 records should be updated');
        System.assertEquals(0, result.failureCount, 'No records should fail');
    }
    
    @isTest
    static void testChangeRecordsOwner_NullRecordIds() {
        String newOwnerId = UserInfo.getUserId();
        
        Test.startTest();
        CustomListViewController.OwnerChangeResult result = 
            CustomListViewController.changeRecordsOwner(null, newOwnerId);
        Test.stopTest();
        
        System.assertEquals(false, result.success, 'Should fail with null record list');
    }
    
    @isTest
    static void testChangeRecordsOwner_ContactRecords() {
        // Test with Contact records to verify it works with different object types
        List<Contact> contacts = [SELECT Id, OwnerId FROM Contact LIMIT 2];
        List<String> contactIds = new List<String>();
        for (Contact con : contacts) {
            contactIds.add(con.Id);
        }
        
        String newOwnerId = UserInfo.getUserId();
        
        Test.startTest();
        CustomListViewController.OwnerChangeResult result = 
            CustomListViewController.changeRecordsOwner(contactIds, newOwnerId);
        Test.stopTest();
        
        System.assertEquals(true, result.success, 'Owner change should succeed for contacts');
        System.assertEquals(2, result.successCount, 'Both contacts should be updated');
    }
    
    @isTest
    static void testOwnerChangeResult_WrapperClass() {
        // Test the wrapper class properties
        CustomListViewController.OwnerChangeResult result = new CustomListViewController.OwnerChangeResult();
        result.success = true;
        result.successCount = 5;
        result.failureCount = 2;
        result.errorMessage = 'Test error';
        result.failedRecordIds = new List<String>{ '001000000000001', '001000000000002' };
        
        System.assertEquals(true, result.success, 'Success should be true');
        System.assertEquals(5, result.successCount, 'Success count should be 5');
        System.assertEquals(2, result.failureCount, 'Failure count should be 2');
        System.assertEquals('Test error', result.errorMessage, 'Error message should match');
        System.assertEquals(2, result.failedRecordIds.size(), 'Failed record IDs should have 2 entries');
    }
}